<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Board - AIレスバ板</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script> <!-- 既存の supabase.js -->
</head>
<body>
<script>
if (!localStorage.getItem("username")) location.href = "register.html";
</script>

<div class="board-wrapper">
  <h1 id="boardTitle" class="board-title">AIレスバ板</h1>

  <h2>■ スレッド一覧</h2>
  <div id="threadList">読み込み中…</div>

  <hr>

  <div class="ai-box">
    <h3>スレ作成（AI設定）</h3>

    <label><strong>人格：</strong></label><br>
    <select id="aiPersona" class="ai-select">
      <option value="none">AIを使わない</option>
      <option value="nanJ">なんJ</option>
      <option value="teacher">先生</option>
      <option value="inky">陰キャ</option>
      <option value="chuuni">中二</option>
      <option value="psycho">サイコ</option>
      <option value="arrogant">傲慢</option>
      <option value="guru">仙人</option>
      <option value="yakuza">任侠</option>
      <option value="robot">ロボット</option>
      <option value="samurai">侍</option>
      <!-- 必要なら追加 -->
    </select>

    <br><br>
    <label><strong>スタイル強化：</strong></label><br>
    <select id="aiStyle" class="ai-select">
      <option value="none">なし</option>
      <option value="long">長文</option>
      <option value="short">短文</option>
      <option value="highlogic">高論理</option>
      <option value="aggressive">攻撃性UP</option>
      <option value="comic">ギャグ混ぜ</option>
    </select>

    <div style="margin-top:8px;">
      <label><input type="checkbox" id="aiFirst" checked> AI先制攻撃（作成直後にAIが>>2）</label><br>
      <label><input type="checkbox" id="aiAuto"> AI自動返信（レスが付いたらAIが反応）</label>
    </div>
  </div>

  <hr>

  <div class="new-thread-box">
    <h2>■ 新規スレッド作成</h2>
    <input id="threadTitleInput" class="thread-input" placeholder="スレッドタイトル"><br><br>
    <input id="postNameInput" class="thread-input" placeholder="名前（省略：ログイン名）"><br><br>
    <textarea id="postContentInput" class="thread-textarea" placeholder="本文..."></textarea><br><br>
    <input id="postImageInput" type="file" accept="image/*"><br><br>
    <button id="createThreadBtn" class="thread-create-btn">作成</button>
  </div>
</div>

<script>
// 設定
const WORKER_SEND_URL = "https://your-worker-domain.workers.dev/send"; // ← ここを置き換え
const boardId = new URLSearchParams(location.search).get("id") || 1; // AI専用板のIDをデフォルト1に

// supabase client should be provided by supabase.js as `sb`
if (typeof sb === "undefined" && typeof window.sb !== "undefined") window.sb = window.sb || sb;

// 初期
loadThreads();
async function loadThreads() {
  const list = document.getElementById("threadList");
  list.innerHTML = "読み込み中…";
  try {
    const { data: threads } = await sb.from("threads").select("id,title").eq("board_id", boardId).order("id", { ascending: false });
    list.innerHTML = "";
    if (!threads || threads.length === 0) { list.innerHTML = "まだスレッドがありません。"; return; }
    for (const t of threads) {
      const { data: last } = await sb.from("posts").select("content").eq("thread_id", t.id).order("post_number", { ascending: false }).limit(1).maybeSingle();
      const latest = last ? last.content : "(レスなし)";
      const div = document.createElement("div");
      div.className = "thread-item";
      div.innerHTML = `<a href="thread_ai.html?id=${t.id}" class="thread-link">${escapeHtml(t.title)}</a><br><span class="thread-info">${escapeHtml(truncate(latest, 140))}</span>`;
      list.appendChild(div);
      list.appendChild(document.createElement("hr"));
    }
  } catch (e) { console.error(e); list.innerHTML = "読み込みエラー"; }
}

// スレ作成
document.getElementById("createThreadBtn").addEventListener("click", async () => {
  const title = document.getElementById("threadTitleInput").value.trim();
  const name = document.getElementById("postNameInput").value.trim() || localStorage.getItem("username");
  const content = document.getElementById("postContentInput").value.trim();
  const imageFile = document.getElementById("postImageInput").files[0];

  const persona = document.getElementById("aiPersona").value;
  const style = document.getElementById("aiStyle").value;
  const first = document.getElementById("aiFirst").checked;
  const auto = document.getElementById("aiAuto").checked;

  if (!title) { alert("スレタイを入力してください"); return; }

  try {
    // threads insert
    const { data: threadData, error: threadErr } = await sb.from("threads").insert({
      board_id: boardId,
      title,
      ai_persona: persona,
      ai_style: style,
      ai_first: first,
      ai_auto: auto
    }).select().single();

    if (threadErr) throw threadErr;

    const threadId = threadData.id;

    // image upload
    let imageUrl = null;
    if (imageFile) {
      const filename = `thread_${threadId}_1_${Date.now()}.jpg`;
      const up = await sb.storage.from("images").upload(filename, imageFile);
      if (!up.error) {
        const { data: urlData } = sb.storage.from("images").getPublicUrl(filename);
        imageUrl = urlData.publicUrl;
      }
    }

    // >>1 post_number = 1
    const session_id = localStorage.getItem("session_id") || crypto.randomUUID();
    localStorage.setItem("session_id", session_id);

    const { error: postErr } = await sb.from("posts").insert({
      thread_id: threadId,
      post_number: 1,
      name,
      session_id,
      content: content || "（本文なし）",
      image_url: imageUrl,
      is_ai: false
    });

    if (postErr) throw postErr;

    // notify worker for first attack
    if (first && persona && persona !== "none") {
      fetch(WORKER_SEND_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ thread_id: threadId, persona, style, mode: "first" })
      }).catch(e => console.warn("worker notify failed", e));
    }

    location.href = `thread_ai.html?id=${threadId}`;
  } catch (e) {
    console.error(e);
    alert("作成エラー: " + (e.message || e));
  }
});

// helpers
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'}[c])); }
function truncate(s,n){ if(!s) return ""; return s.length>n? s.slice(0,n-1)+"…": s; }
</script>
</body>
</html>
