<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スレッド</title>
    <link rel="stylesheet" href="style.css">
    <script src="supabase.js"></script>
</head>

<body>

<div class="thread-wrapper">

    <h1 id="threadTitle" class="thread-title"></h1>

    <div id="postArea" class="post-area"></div>

    <hr>

    <!-- ▼▼ レス投稿フォーム ▼▼ -->
    <div class="post-form">
        <h2>■ レス投稿</h2>

        <input id="postName" type="text" placeholder="名前（省略時：名無しさん）" class="post-input"><br><br>

        <textarea id="postContent" placeholder="本文を入力…" class="post-textarea"></textarea><br><br>

        <input id="postImage" type="file" accept="image/*"><br><br>

        <button onclick="postReply()" class="post-btn">投稿</button>

        <div id="log" style="margin-top:20px; font-size:12px; color:#555;"></div>
    </div>

</div>


<script>
// ---------------------------------------------
// URL から thread ID 取得
// ---------------------------------------------
const urlParams = new URLSearchParams(window.location.search);
const threadId = urlParams.get("id");

if (!threadId) {
    document.body.innerHTML = "<h2>threadId がありません。</h2>";
}

// ---------------------------------------------
// デバッグログ
// ---------------------------------------------
function addLog(msg) {
    const box = document.getElementById("log");
    box.innerHTML += msg + "<br>";
}

// ---------------------------------------------
// スレタイ読み込み
// ---------------------------------------------
async function loadThreadTitle() {
    addLog("▶ loadThreadTitle START");

    const { data, error } = await sb
        .from("threads")
        .select("title")
        .eq("id", threadId)
        .single();

    if (error) {
        addLog("❌ スレタイ読み込みエラー: " + error.message);
        return;
    }

    document.getElementById("threadTitle").textContent = data.title;

    addLog("✔ スレタイ読み込み完了");
}

// ---------------------------------------------
// レス一覧読み込み
// ---------------------------------------------
async function loadPosts() {
    addLog("▶ loadPosts START");

    const { data, error } = await sb
        .from("posts")
        .select("*")
        .eq("thread_id", threadId)
        .order("id", { ascending: true });

    if (error) {
        addLog("❌ レス読み込みエラー: " + error.message);
        return;
    }

    const box = document.getElementById("postArea");
    box.innerHTML = "";

    data.forEach(p => {
        const div = document.createElement("div");
        div.className = "res-item";
        div.id = `res-${p.id}`;

        div.innerHTML = `
            <div class="res-meta">
                ${p.id} ：${p.name} ：ID:${makeID(p.name, p.id)}
            </div>

            <div class="res-body">
                ${applyAnchors(p.content)}
            </div>

            ${p.image_url ? `<img src="${p.image_url}" class="res-image">` : ""}
        `;

        box.appendChild(div);
    });

    addLog("✔ レス読み込み完了");

    // 最下部へスクロール
    window.scrollTo(0, document.body.scrollHeight);
}

// ---------------------------------------------
// アンカー（>>数字）
// ---------------------------------------------
function applyAnchors(text) {
    return text.replace(/>>(\d+)/g, (m, num) =>
        `<a href="#res-${num}" onclick="highlight(${num});return false;">>>${num}</a>`
    );
}

function highlight(num) {
    const el = document.getElementById(`res-${num}`);
    if (!el) return;

    el.style.background = "#FFEE99";
    setTimeout(() => el.style.background = "", 700);
}

// ---------------------------------------------
// ID 生成（簡易 2ch 風）
// ---------------------------------------------
function makeID(name, seed) {
    const base = name + seed;
    return btoa(base).substring(0, 8);
}

// ---------------------------------------------
// レス投稿
// ---------------------------------------------
async function postReply() {
    addLog("▶ postReply START");

    const name = document.getElementById("postName").value.trim() || "名無しさん";
    const content = document.getElementById("postContent").value.trim();
    const file = document.getElementById("postImage").files[0];

    if (!content && !file) {
        alert("本文か画像を入力してください");
        return;
    }

    let imageUrl = null;

    // ---------- 画像アップロード ----------
    if (file) {
        addLog("画像アップロード処理開始…");

        const fileName = `post_${threadId}_${Date.now()}.jpg`;

        const { error: uploadErr } = await sb.storage
            .from("images")
            .upload(fileName, file);

        if (uploadErr) {
            addLog("❌ 画像アップロード失敗: " + uploadErr.message);
        } else {
            const { data: urlData } = sb.storage
                .from("images")
                .getPublicUrl(fileName);

            imageUrl = urlData.publicUrl;
            addLog("✔ 画像アップロード成功");
        }
    }

    // ---------- 投稿処理 ----------
    addLog("INSERT posts 実行中…");

    const { error: postErr } = await sb
        .from("posts")
        .insert({
            thread_id: threadId,
            name,
            content,
            image_url: imageUrl
        });

    if (postErr) {
        addLog("❌ 投稿エラー: " + postErr.message);
        return;
    }

    addLog("✔ 投稿完了");

    document.getElementById("postContent").value = "";
    document.getElementById("postImage").value = "";

    loadPosts();
}

// ---------------------------------------------
// 初期ロード
// ---------------------------------------------
loadThreadTitle();
loadPosts();

</script>

</body>
</html>
