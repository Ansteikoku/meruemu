<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スレッド</title>
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>

<body>

<div class="thread-wrapper">

    <h1 id="threadTitle" class="thread-title"></h1>

    <div id="postArea" class="post-area"></div>

    <hr>

    <!-- ▼▼ レス投稿フォーム ▼▼ -->
    <div class="post-form">
        <h2>■ レス投稿</h2>

        <input id="userName" type="text" placeholder="名前（登録済みユーザー）" class="post-input"><br><br>
        <input id="userPass" type="password" placeholder="パスワード" class="post-input"><br><br>

        <textarea id="postContent" placeholder="本文を入力…" class="post-textarea"></textarea><br><br>

        <input id="postImage" type="file" accept="image/*"><br><br>

        <button onclick="postReply()" class="post-btn">投稿</button>
    </div>

</div>

<script>
/* ---------------------------------------------------------
   共通：SHA256 & ログイン関数
--------------------------------------------------------- */
async function sha256(text) {
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = [...new Uint8Array(hashBuffer)];
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

async function getUserIdByLogin(username, password){
    const passwordHash = await sha256(password);

    const { data } = await sb
        .from("users")
        .select("*")
        .eq("username", username)
        .eq("password_hash", passwordHash)
        .maybeSingle();

    if (!data) return null;
    return data.id;
}

/* ---------------------------------------------------------
   URL から thread_id を取得
--------------------------------------------------------- */
const urlParams = new URLSearchParams(window.location.search);
const threadId = urlParams.get("id");

/* ---------------------------------------------------------
   スレタイ取得
--------------------------------------------------------- */
async function loadThreadTitle() {
    const { data } = await sb
        .from("threads")
        .select("title")
        .eq("id", threadId)
        .single();

    document.getElementById("threadTitle").textContent = data.title;
}

/* ---------------------------------------------------------
   アンカー >>数字 → 該当レスへジャンプ
--------------------------------------------------------- */
function applyAnchors(text) {
    return text.replace(/>>(\d+)/g, (m, num) =>
        `<a href="#res-${num}" onclick="highlight(${num});return false;">>>${num}</a>`
    );
}

function highlight(num) {
    const el = document.getElementById(`res-${num}`);
    if (!el) return;
    el.style.background = "#FFEB8A";
    setTimeout(() => el.style.background = "", 700);
}

/* ---------------------------------------------------------
   レス一覧を読み込み
--------------------------------------------------------- */
async function loadPosts() {
    const { data } = await sb
        .from("posts")
        .select("*")
        .eq("thread_id", threadId)
        .order("id", { ascending: true });

    const box = document.getElementById("postArea");
    box.innerHTML = "";

    data.forEach(p => {
        const div = document.createElement("div");
        div.className = "res-item";
        div.id = `res-${p.id}`;

        div.innerHTML = `
            <div class="res-meta">
                <b>${p.id}</b> ：${p.name}
            </div>

            <div class="res-body">
                ${applyAnchors(p.content)}
            </div>

            ${ p.image_url ? `<img src="${p.image_url}" class="res-image">` : "" }
        `;

        box.appendChild(div);
    });
}

/* ---------------------------------------------------------
   レス投稿
--------------------------------------------------------- */
async function postReply() {
    const username = document.getElementById("userName").value.trim();
    const password = document.getElementById("userPass").value.trim();
    const content = document.getElementById("postContent").value.trim();
    const imageFile = document.getElementById("postImage").files[0];

    if (!username || !password) {
        alert("名前とパスワードを入力してください");
        return;
    }

    if (!content && !imageFile) {
        alert("本文か画像を入力してください");
        return;
    }

    // 認証して user_id を取得
    const userId = await getUserIdByLogin(username, password);
    if (!userId) {
        alert("名前またはパスワードが違います");
        return;
    }

    // 画像アップロード（任意）
    let imageUrl = null;
    if (imageFile) {
        const fileName = `reply_${threadId}_${Date.now()}.jpg`;
        const { error: uploadErr } = await sb.storage
            .from("images")
            .upload(fileName, imageFile);

        if (!uploadErr) {
            const { data: urlData } = sb.storage
                .from("images")
                .getPublicUrl(fileName);
            imageUrl = urlData.publicUrl;
        }
    }

    // 投稿
    await sb.from("posts").insert({
        thread_id: threadId,
        name: username,
        content: content,
        image_url: imageUrl,
        user_id: userId
    });

    document.getElementById("postContent").value = "";
    document.getElementById("postImage").value = "";

    // 最新レスへスクロール
    await loadPosts();
    window.location.hash = "#res-bottom";
}

/* ---------------------------------------------------------
   初期ロード
--------------------------------------------------------- */
loadThreadTitle();
loadPosts();

</script>

</body>
</html>
