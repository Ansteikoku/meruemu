<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スレッド</title>
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<div class="thread-wrapper">

    <h1 id="threadTitle" class="thread-title">読み込み中…</h1>

    <hr>

    <!-- ▼ レス一覧 -->
    <div id="postArea">読み込み中…</div>

    <hr>

    <!-- ▼ レス投稿フォーム -->
    <div class="new-post-box">
        <h2>■ レス投稿</h2>

        <input id="postName" type="text" placeholder="名前（省略時：名無しさん）" class="post-input"><br><br>

        <textarea id="postContent" placeholder="本文…" class="post-textarea"></textarea><br><br>

        <input id="postImage" type="file" accept="image/*"><br><br>

        <button onclick="sendPost()" class="post-btn">投稿</button>
    </div>

</div>

<script>
// ==========================================
// URL 取得
// ==========================================
const urlParams = new URLSearchParams(window.location.search);
const threadId = urlParams.get("id");

if (!threadId) {
    document.getElementById("threadTitle").textContent = "ID 取得エラー";
}


// ==========================================
// スレタイトル読み込み
// ==========================================
async function loadThreadTitle() {
    const { data, error } = await sb
        .from("threads")
        .select("title")
        .eq("id", threadId)
        .single();

    if (error) {
        document.getElementById("threadTitle").textContent = "エラー";
        return;
    }

    document.getElementById("threadTitle").textContent = data.title;
}



// ==========================================
// レス一覧（番号を 1 から採番 / アンカー対応）
// ==========================================
async function loadPosts() {
    const { data, error } = await sb
        .from("posts")
        .select("*")
        .eq("thread_id", threadId)
        .order("id", { ascending: true });

    const box = document.getElementById("postArea");
    box.innerHTML = "";

    if (!data || data.length === 0) {
        box.innerHTML = "レスがありません。";
        return;
    }

    data.forEach((p, index) => {
        const resNumber = index + 1;   // ★ 表示番号

        const div = document.createElement("div");
        div.className = "res-item";
        div.id = `res-${resNumber}`;  // ★ アンカー用 ID

        div.innerHTML = `
            <div class="res-meta">#${resNumber} ： ${p.name}</div>

            <div class="res-body">
                ${applyAnchors(p.content)}
            </div>

            ${p.image_url ? `<img src="${p.image_url}" class="res-image">` : ""}
        `;

        box.appendChild(div);
    });
}



// ==========================================
// >>アンカー書き換え（>>3 → #res-3 に飛ぶ）
// ==========================================
function applyAnchors(text) {
    if (!text) return "";
    return text.replace(/>>(\d+)/g, (m, num) =>
        `<a href="#res-${num}" onclick="gotoRes(${num});return false;">>>${num}</a>`
    );
}



// ==========================================
// アンカーでスクロール + ハイライト
// ==========================================
function gotoRes(num) {
    const el = document.getElementById(`res-${num}`);
    if (!el) return;

    el.scrollIntoView({
        behavior: "smooth",
        block: "center"
    });

    el.style.background = "#fff3a0";
    setTimeout(() => {
        el.style.background = "";
    }, 900);
}



// ==========================================
// レス投稿
// ==========================================
async function sendPost() {
    const name = document.getElementById("postName").value.trim() || "名無しさん";
    const content = document.getElementById("postContent").value.trim();
    const imageFile = document.getElementById("postImage").files[0];

    if (!content && !imageFile) {
        alert("本文か画像を入力してください");
        return;
    }

    let imageUrl = null;

    if (imageFile) {
        const fileName = `post_${threadId}_${Date.now()}.jpg`;
        const { error: uploadErr } = await sb.storage
            .from("images")
            .upload(fileName, imageFile);

        if (!uploadErr) {
            const { data: urlData } = sb.storage
                .from("images")
                .getPublicUrl(fileName);
            imageUrl = urlData.publicUrl;
        }
    }

    await sb.from("posts").insert({
        thread_id: threadId,
        name: name,
        content: content,
        image_url: imageUrl
    });

    // 入力欄クリア
    document.getElementById("postName").value = "";
    document.getElementById("postContent").value = "";
    document.getElementById("postImage").value = "";

    // 再読み込み
    loadPosts();

    // 最新レスへ自動スクロール
    setTimeout(() => {
        const lastId = document.querySelectorAll(".res-item").length;
        gotoRes(lastId);
    }, 400);
}



// ==========================================
// 初期ロード
// ==========================================
loadThreadTitle();
loadPosts();

</script>

</body>
</html>
