<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スレッド</title>
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<script>
// ▼ ログインチェック
if (!localStorage.getItem("username")) {
    window.location.href = "login.html";
}
</script>

<div class="thread-wrapper">

    <h1 id="threadTitle" class="thread-title"></h1>

    <div id="postArea" class="post-area"></div>

    <hr>

    <!-- ▼ レス投稿フォーム -->
    <div class="post-form">
        <h2>■ レス投稿</h2>

        <input id="postName" type="text" placeholder="名前（省略時：名無しさん）" class="post-input"><br><br>

        <textarea id="postContent" placeholder="本文を入力…" class="post-textarea"></textarea><br><br>

        <input id="postImage" type="file" accept="image/*"><br><br>

        <button onclick="postReply()" class="post-btn">投稿</button>
    </div>

</div>

<script>
// URL
const threadId = new URLSearchParams(window.location.search).get("id");

let lastLoaded = 0;

// ---------------------------------------------
// 2ch風 日付フォーマット
// ---------------------------------------------
function formatDate(dateStr) {
    const d = new Date(dateStr);

    const week = ["日", "月", "火", "水", "木", "金", "土"];
    const w = week[d.getDay()];

    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");
    const ss = String(d.getSeconds()).padStart(2, "0");

    return `${mm}/${dd}(${w}) ${hh}:${mi}:${ss}`;
}

// ---------------------------------------------
// 2ch風 ID:xxxxx 生成（毎日変わる）
// ---------------------------------------------
function generateID(name, dateStr) {
    const d = new Date(dateStr);

    const seed = name + d.getFullYear() + d.getMonth() + d.getDate();
    let hash = 0;

    for (let i = 0; i < seed.length; i++) {
        hash = (hash * 31 + seed.charCodeAt(i)) & 0xffffffff;
    }

    return Math.abs(hash).toString(36).substring(0, 8);
}

// ---------------------------------------------
// アンカー処理
// ---------------------------------------------
function applyAnchors(text) {
    return text.replace(/>>(\d+)/g, (m, num) =>
        `<a href="#res-${num}" onclick="jumpTo(${num}); return false;">>>${num}</a>`
    );
}

function jumpTo(num) {
    const target = document.getElementById(`res-${num}`);
    if (!target) return;

    target.scrollIntoView({ behavior: "smooth", block: "center" });

    target.classList.add("highlight");
    setTimeout(() => target.classList.remove("highlight"), 1200);
}

// ---------------------------------------------
// スレタイ
// ---------------------------------------------
async function loadThreadTitle() {
    const { data } = await sb
        .from("threads")
        .select("title")
        .eq("id", threadId)
        .single();

    if (data) {
        document.getElementById("threadTitle").textContent = data.title;
    }
}

// ---------------------------------------------
// レス一覧（連番 + 時間 + ID）
// ---------------------------------------------
async function loadPosts(auto = false) {

    const { data: posts } = await sb
        .from("posts")
        .select("*")
        .eq("thread_id", threadId)
        .order("id", { ascending: true });

    const box = document.getElementById("postArea");
    box.innerHTML = "";

    let num = 1;

    posts.forEach(p => {

        const time = formatDate(p.created_at);
        const id = generateID(p.name, p.created_at);

        box.innerHTML += `
            <div class="res-item" id="res-${num}">
                <div class="res-meta">
                    ${num}：${p.name}：${time}：ID:${id}
                </div>

                <div class="res-body">
                    ${applyAnchors(p.content)}
                </div>

                ${p.image_url ? `<img src="${p.image_url}" class="res-image">` : ""}
            </div>
            <hr>
        `;

        num++;
    });
}

// ---------------------------------------------
// レス投稿
// ---------------------------------------------
async function postReply() {

    const name = document.getElementById("postName").value.trim() || localStorage.getItem("username");
    const content = document.getElementById("postContent").value.trim();
    const imageFile = document.getElementById("postImage").files[0];

    if (!content && !imageFile) {
        alert("本文か画像を入力してください");
        return;
    }

    let imageUrl = null;

    if (imageFile) {
        const fileName = `reply_${threadId}_${Date.now()}.jpg`;
        await sb.storage.from("images").upload(fileName, imageFile);
        const { data: urlData } = sb.storage.from("images").getPublicUrl(fileName);
        imageUrl = urlData.publicUrl;
    }

    await sb.from("posts").insert({
        thread_id: threadId,
        name,
        content,
        image_url: imageUrl
    });

    document.getElementById("postContent").value = "";
    document.getElementById("postImage").value = "";

    loadPosts();
}

// ---------------------------------------------
// 自動リロード（5秒）
// ---------------------------------------------
setInterval(() => {
    loadPosts(true);
}, 5000);

// 初期ロード
loadThreadTitle();
loadPosts();

</script>

</body>
</html>
