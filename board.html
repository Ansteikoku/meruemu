<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>板 - スレ一覧</title>
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<div class="board-wrapper">

    <h1 id="boardTitle" class="board-title"></h1>

    <!-- ▼ スレッド一覧 -->
    <h2>■ スレッド一覧</h2>
    <div id="threadList">読み込み中…</div>

    <hr>

    <!-- ▼ 新規スレ作成フォーム -->
    <div class="new-thread-box">
        <h2>■ 新規スレッド作成</h2>

        <input id="threadTitle" type="text" placeholder="スレッドタイトル" class="thread-input"><br><br>

        <input id="userName" type="text" placeholder="名前（登録済み）" class="thread-input"><br><br>
        <input id="userPass" type="password" placeholder="パスワード" class="thread-input"><br><br>

        <textarea id="postContent" placeholder="本文を入力…" class="thread-textarea"></textarea><br><br>

        <input id="postImage" type="file" accept="image/*"><br><br>

        <button onclick="createThread()" class="thread-create-btn">作成</button>
    </div>

</div>

<script>
// ----------------------------------------------
// 共有ログイン・ハッシュ関数
// ----------------------------------------------
async function sha256(text) {
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = [...new Uint8Array(hashBuffer)];
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

async function getUserIdByLogin(username, password){
    const passwordHash = await sha256(password);

    const { data, error } = await sb
        .from("users")
        .select("*")
        .eq("username", username)
        .eq("password_hash", passwordHash)
        .maybeSingle();

    if (!data) return null;
    return data.id;
}

// ----------------------------------------------
// URL取得
// ----------------------------------------------
const urlParams = new URLSearchParams(window.location.search);
const boardId = urlParams.get("b") || urlParams.get("id");

// ----------------------------------------------
// 板名読み込み
// ----------------------------------------------
async function loadBoard() {
    const { data } = await sb
        .from("boards")
        .select("title")
        .eq("id", boardId)
        .single();

    document.getElementById("boardTitle").textContent = data.title;
}

// ----------------------------------------------
// スレ一覧（最新レスつき）
// ----------------------------------------------
async function loadThreads() {

    const { data: threads } = await sb
        .from("threads")
        .select("*")
        .eq("board_id", boardId)
        .order("id", { ascending: false });

    const box = document.getElementById("threadList");
    box.innerHTML = "";

    for (const t of threads) {

        const { data: last } = await sb
            .from("posts")
            .select("content")
            .eq("thread_id", t.id)
            .order("id", { ascending: false })
            .limit(1)
            .maybeSingle();

        const latest = last ? last.content : "(レスなし)";

        box.innerHTML += `
            <div class="thread-item">
                <a href="thread.html?id=${t.id}" class="thread-link">${t.title}</a><br>
                <span class="latest-post">${latest}</span>
            </div><hr>
        `;
    }
}

// ----------------------------------------------
// スレ作成（>>1 含む）
// ----------------------------------------------
async function createThread() {

    const title = document.getElementById("threadTitle").value.trim();
    const username = document.getElementById("userName").value.trim();
    const password = document.getElementById("userPass").value.trim();
    const content = document.getElementById("postContent").value.trim() || "（本文なし）";
    const imageFile = document.getElementById("postImage").files[0];

    if (!title) { alert("スレタイを入力"); return; }
    if (!username || !password) {
        alert("名前とパスワードを入力してください");
        return;
    }

    const userId = await getUserIdByLogin(username, password);
    if (!userId) {
        alert("名前またはパスワードが違います");
        return;
    }

    // threads に user_id を保存
    const { data: tdata, error } = await sb
        .from("threads")
        .insert({
            board_id: boardId,
            title: title,
            user_id: userId
        })
        .select()
        .single();

    const threadId = tdata.id;

    // 画像
    let imageUrl = null;
    if (imageFile) {
        const fileName = `thread_${threadId}_1_${Date.now()}.jpg`;
        await sb.storage.from("images").upload(fileName, imageFile);
        const { data: urlData } = sb.storage.from("images").getPublicUrl(fileName);
        imageUrl = urlData.publicUrl;
    }

    // >>1 投稿
    await sb.from("posts").insert({
        thread_id: threadId,
        name: username,
        content: content,
        image_url: imageUrl,
        user_id: userId
    });

    // スレへ移動
    window.location.href = `thread.html?id=${threadId}`;
}

// ----------------------------------------------
loadBoard();
loadThreads();

</script>

</body>
</html>
