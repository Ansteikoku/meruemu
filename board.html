<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>板 - スレ一覧</title>
    <link rel="stylesheet" href="style.css">
    <script src="supabase.js"></script>
</head>
<body>

<div class="board-wrapper">

    <h1 id="boardTitle" class="board-title"></h1>

    <!-- ▼▼ 新規スレッド作成 ▼▼ -->
    <div class="new-thread-box">
        <h2>■ 新規スレッド作成</h2>

        <input id="threadTitle" type="text" placeholder="スレッドタイトル" class="thread-input"><br><br>

        <input id="postName" type="text" placeholder="名前（省略時：名無しさん）" class="thread-input"><br><br>

        <textarea id="postContent" placeholder="本文を入力…" class="thread-textarea"></textarea><br><br>

        <input id="postImage" type="file" accept="image/*"><br><br>

        <button onclick="createThread()" class="thread-create-btn">作成</button>
    </div>

    <hr>

    <h2>■ スレッド一覧</h2>
    <ul id="threadList" class="thread-list"></ul>

</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const boardId = urlParams.get("id");

// ▼ 板名取得
async function loadBoard() {
    const { data } = await supabase.from("boards").select("title").eq("id", boardId).single();
    document.getElementById("boardTitle").textContent = data.title;
}

// ▼ スレ一覧取得
async function loadThreads() {
    const { data } = await supabase
        .from("threads")
        .select("*")
        .eq("board_id", boardId)
        .order("id", { ascending: false });

    const list = document.getElementById("threadList");
    list.innerHTML = "";

    data.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="thread.html?id=${t.id}" class="thread-link">${t.title}</a>`;
        list.appendChild(li);
    });
}

// ▼ スレ作成（>>1 自動投稿つき）
async function createThread() {

    const title = document.getElementById("threadTitle").value.trim();
    const name = document.getElementById("postName").value.trim() || "名無しさん";
    const content = document.getElementById("postContent").value.trim();
    const imageFile = document.getElementById("postImage").files[0];

    if (!title) {
        alert("スレタイを入力してください");
        return;
    }

    // ---- Step 1: スレッドを作成 ----
    const { data: threadData, error: threadErr } = await supabase
        .from("threads")
        .insert({ board_id: boardId, title })
        .select()
        .single();

    if (threadErr) {
        alert("スレ作成エラー：" + threadErr.message);
        return;
    }

    const threadId = threadData.id;

    // ---- Step 2: 画像アップロード ----
    let imageUrl = null;

    if (imageFile) {
        const fileName = `thread_${threadId}_1_${Date.now()}.jpg`;

        const { error: uploadErr } = await supabase.storage
            .from("images")
            .upload(fileName, imageFile);

        if (!uploadErr) {
            const { data: urlData } = supabase.storage
                .from("images")
                .getPublicUrl(fileName);
            imageUrl = urlData.publicUrl;
        }
    }

    // ---- Step 3: >>1 を自動投稿 ----
    await supabase.from("posts").insert({
        thread_id: threadId,
        name: name,
        content: content || "（本文なし）",
        image_url: imageUrl
    });

    // ---- 完了 ----
    document.getElementById("threadTitle").value = "";
    document.getElementById("postName").value = "";
    document.getElementById("postContent").value = "";
    document.getElementById("postImage").value = "";

    alert("スレッドを作成しました！");
    loadThreads();
}

loadBoard();
loadThreads();
</script>

</body>
</html>
