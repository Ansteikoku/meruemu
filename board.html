<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>板 - スレ一覧</title>
    <link rel="stylesheet" href="style.css">
    <script src="supabase.js"></script>
</head>
<body>

<div class="board-wrapper">

    <h1 id="boardTitle" class="board-title"></h1>

    <h2>■ スレッド一覧</h2>
    <div id="threadList">読み込み中…</div>

    <hr>

    <div class="new-thread-box">
        <h2>■ 新規スレッド作成</h2>

        <input id="threadTitle" type="text" placeholder="スレッドタイトル" class="thread-input"><br><br>
        <input id="postName" type="text" placeholder="名前（省略時：名無しさん）" class="thread-input"><br><br>
        <textarea id="postContent" placeholder="本文を入力…" class="thread-textarea"></textarea><br><br>
        <input id="postImage" type="file" accept="image/*"><br><br>

        <button onclick="createThread()" class="thread-create-btn">作成</button>

        <!-- ▼▼ ここにログを出す ▼▼ -->
        <div id="log" style="margin-top:15px; background:#EEE; padding:10px; border:1px solid #CCC; height:150px; overflow-y:scroll; font-size:12px;"></div>
    </div>

</div>

<script>
/* ------------------------------
    ログ出力（コンソール代わり）
------------------------------ */
function addLog(msg) {
    const log = document.getElementById("log");
    log.innerHTML += msg + "<br>";
}

/* ------------------------------
    URLパラメータ
------------------------------ */
addLog("▶ Board ページ開始");

const urlParams = new URLSearchParams(window.location.search);
const boardId = urlParams.get("b");

if (!boardId) {
    addLog("❌ boardId がありません");
}

/* ------------------------------
    板名読み込み
------------------------------ */
async function loadBoard() {
    addLog("▶ loadBoard START (boardId=" + boardId + ")");

    const { data, error } = await sb
        .from("boards")
        .select("title")
        .eq("id", boardId)
        .single();

    if (error) {
        addLog("❌ 板名読込エラー: " + error.message);
        return;
    }

    document.getElementById("boardTitle").textContent = data.title;

    addLog("✔ 板名読込成功: " + data.title);
}

/* ------------------------------
    スレ一覧読み込み
------------------------------ */
async function loadThreads() {
    addLog("▶ loadThreads START");

    const box = document.getElementById("threadList");

    const { data: threads, error } = await sb
        .from("threads")
        .select("*")
        .eq("board_id", boardId)
        .order("id", { ascending: false });

    if (error) {
        addLog("❌ threads 読込エラー: " + error.message);
        box.innerHTML = "エラー";
        return;
    }

    box.innerHTML = "";

    addLog("✔ スレ数: " + threads.length);

    for (const t of threads) {

        // 最新レス取得
        const { data: last } = await sb
            .from("posts")
            .select("*")
            .eq("thread_id", t.id)
            .order("id", { ascending: false })
            .limit(1)
            .single();

        const lastText = last ? last.content : "（まだレスなし）";

        box.innerHTML += `
            <div class="thread-item">
                <a href="thread.html?id=${t.id}" class="thread-link">
                    <b>${t.title}</b>
                </a>
                <div class="thread-info">
                    最新レス：${lastText}
                </div>
                <button onclick="goToThread(${t.id})" class="reply-btn">レス投稿する</button>
            </div>
        `;
    }

    addLog("✔ スレ一覧表示完了");
}

function goToThread(id) {
    addLog("➡ thread.html?id=" + id + " へ移動");
    window.location.href = `thread.html?id=${id}`;
}

/* ------------------------------
    スレ作成（>>1 自動投稿 + 移動）
------------------------------ */
async function createThread() {
    addLog("▶ createThread START");

    const title = document.getElementById("threadTitle").value.trim();
    const name = document.getElementById("postName").value.trim() || "名無しさん";
    const content = document.getElementById("postContent").value.trim() || "（本文なし）";
    const file = document.getElementById("postImage").files[0];

    if (!title) {
        alert("スレタイを入力してください");
        addLog("❌ スレタイ未入力");
        return;
    }

    addLog("INSERT threads 実行中…");

    // threads へ追加
    const { data: thread, error: threadErr } = await sb
        .from("threads")
        .insert({
            board_id: boardId,
            title: title
        })
        .select()
        .single();

    if (threadErr) {
        addLog("❌ threads 追加失敗: " + threadErr.message);
        return;
    }

    addLog("✔ threads 追加成功 → threadId=" + thread.id);

    const threadId = thread.id;

    /* ---------------- 画像アップロード ---------------- */
    let imageUrl = null;

    if (file) {
        addLog("画像アップロード開始…");

        const fileName = `thread_${threadId}_1_${Date.now()}.jpg`;

        const { error: uploadErr } = await sb.storage
            .from("images")
            .upload(fileName, file);

        if (uploadErr) {
            addLog("❌ 画像アップロード失敗: " + uploadErr.message);
        } else {
            const { data: urlData } = sb.storage
                .from("images")
                .getPublicUrl(fileName);

            imageUrl = urlData.publicUrl;

            addLog("✔ 画像アップロード成功: " + imageUrl);
        }
    }

    /* ---------------- >>1 を投稿 ---------------- */
    addLog("INSERT posts(>>1) 実行中…");

    const { error: postErr } = await sb
        .from("posts")
        .insert({
            thread_id: threadId,
            name,
            content,
            image_url: imageUrl
        });

    if (postErr) {
        addLog("❌ >>1 投稿失敗: " + postErr.message);
        return;
    }

    addLog("✔ >>1 投稿完了");
    addLog("➡ thread.html?id=" + threadId + " に移動します");

    // thread.html へ移動
    window.location.href = `thread.html?id=${threadId}`;
}

/* ------------------------------
    初期実行
------------------------------ */
loadBoard();
loadThreads();

addLog("✔ Board ページロード完了");

</script>

</body>
</html>
