<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Thread - AI対応</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body>
<script>
if (!localStorage.getItem("username")) location.href = "register.html";
</script>

<div class="thread-wrapper">
  <h1 id="threadTitle" class="thread-title">読み込み中…</h1>
  <div id="postArea">読み込み中…</div>
  <hr>

  <div class="post-form">
    <h2>■ レス投稿</h2>
    <textarea id="postContent" class="post-textarea" placeholder="本文"></textarea><br><br>
    <input id="postImage" type="file" accept="image/*"><br><br>
    <button id="postBtn" class="post-btn">投稿</button>
  </div>
</div>

<script>
const WORKER_SEND_URL = "https://your-worker-domain.workers.dev/send"; // ← 置き換え
const threadId = new URLSearchParams(location.search).get("id");

// thread AI settings
let threadAI = { persona:"none", style:"none", ai_first:false, ai_auto:false };

if (typeof sb === "undefined" && typeof window.sb !== "undefined") window.sb = window.sb || sb;

// 初期ロード
loadThread();
loadPosts();
setInterval(loadPosts, 4000);

// load thread meta
async function loadThread(){
  try {
    const { data: thread } = await sb.from("threads").select("*").eq("id", threadId).single();
    if (!thread) { document.getElementById("threadTitle").textContent = "スレが見つかりません"; return; }
    document.getElementById("threadTitle").textContent = thread.title;
    threadAI.persona = thread.ai_persona || "none";
    threadAI.style = thread.ai_style || "none";
    threadAI.ai_first = !!thread.ai_first;
    threadAI.ai_auto = !!thread.ai_auto;
  } catch (e) { console.error(e); }
}

// load posts
async function loadPosts(){
  try {
    const { data: posts } = await sb.from("posts").select("*").eq("thread_id", threadId).order("post_number", { ascending: true });
    const area = document.getElementById("postArea");
    area.innerHTML = "";
    if (!posts || posts.length === 0) { area.innerHTML = "まだレスがありません。"; return; }
    for (const p of posts) {
      const div = document.createElement("div");
      div.className = "res-item";
      div.id = `res-${p.post_number}`;
      div.innerHTML = `
        <div class="res-meta">${p.post_number}：${escapeHtml(p.name)}：${formatJST(p.created_at)}：ID:${escapeHtml(p.session_id || '')}</div>
        <div class="res-body">${applyAnchors(escapeHtml(p.content))}${p.image_url?'<br><img src="'+escapeHtml(p.image_url)+'" class="res-image">':''}</div>
      `;

      // AI応答ボタン
      const aiBtn = document.createElement("button");
      aiBtn.className = "ai-auto-btn";
      aiBtn.textContent = "AIで返す";
      aiBtn.onclick = () => triggerAiForPost(p.post_number, p.content);
      div.appendChild(aiBtn);

      area.appendChild(div);
      area.appendChild(document.createElement("hr"));
    }
  } catch (e) { console.error(e); }
}

// post reply (auto post_number)
document.getElementById("postBtn").addEventListener("click", async () => {
  const content = document.getElementById("postContent").value.trim();
  const file = document.getElementById("postImage").files[0];
  const name = localStorage.getItem("username");
  if (!content && !file) { alert("本文か画像を入れてください"); return; }

  try {
    // upload image if any
    let imageUrl = null;
    if (file) {
      const filename = `post_${threadId}_${Date.now()}.jpg`;
      const up = await sb.storage.from("images").upload(filename, file);
      if (!up.error) {
        const { data: urlData } = sb.storage.from("images").getPublicUrl(filename);
        imageUrl = urlData.publicUrl;
      }
    }

    // get last post_number
    const { data: last } = await sb.from("posts").select("post_number").eq("thread_id", threadId).order("post_number", { ascending: false }).limit(1);
    let nextNumber = 1;
    if (last && last.length > 0) nextNumber = last[0].post_number + 1;

    const session_id = localStorage.getItem("session_id") || crypto.randomUUID();
    localStorage.setItem("session_id", session_id);

    // insert
    const { error } = await sb.from("posts").insert({
      thread_id: threadId,
      post_number: nextNumber,
      name,
      session_id,
      content,
      image_url: imageUrl,
      is_ai: false
    });

    if (error) throw error;

    // AI auto notify
    if (threadAI.ai_auto && threadAI.persona && threadAI.persona !== "none") {
      fetch(WORKER_SEND_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          thread_id: threadId,
          persona: threadAI.persona,
          style: threadAI.style,
          mode: "auto",
          last_post_number: nextNumber,
          last_post_text: content
        })
      }).catch(e => console.warn("worker notify failed", e));
    }

    // clear & reload
    document.getElementById("postContent").value = "";
    document.getElementById("postImage").value = "";
    loadPosts();
  } catch (e) {
    console.error(e);
    alert("投稿に失敗しました: " + (e.message || e));
  }
});

// trigger AI for a specific post
async function triggerAiForPost(targetNumber, targetText) {
  if (!threadAI.persona || threadAI.persona === "none") { alert("このスレはAI設定がありません。"); return; }
  try {
    const res = await fetch(WORKER_SEND_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        thread_id: threadId,
        persona: threadAI.persona,
        style: threadAI.style,
        mode: "reply",
        target_post_number: targetNumber,
        last_post_text: targetText
      })
    });
    const j = await res.json();
    if (j?.status === "ok") setTimeout(loadPosts, 800);
    else alert("AI応答に失敗しました");
  } catch (e) { console.error(e); alert("AI呼び出しエラー"); }
}

// helpers
function applyAnchors(text){ return text.replace(/&gt;&gt;(\d+)/g, (m,n)=>`<a href="#res-${n}" onclick="document.getElementById('res-${n}')?.scrollIntoView({behavior:'smooth'})">${'&gt;&gt;'+n}</a>`); }
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'}[c])); }
function formatJST(iso){ try{ const d=new Date(iso); const j=new Date(d.getTime()+9*60*60*1000); const mm=String(j.getMonth()+1).padStart(2,'0'); const dd=String(j.getDate()).padStart(2,'0'); const hh=String(j.getHours()).padStart(2,'0'); const m=String(j.getMinutes()).padStart(2,'0'); return `${mm}/${dd} ${hh}:${m}` }catch(e){return iso} }
</script>
</body>
</html>
