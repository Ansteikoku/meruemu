<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ–°è¦ç™»éŒ²</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<div class="container">
    <h1>æ–°è¦ç™»éŒ²</h1>

    <p>æ²ç¤ºæ¿ã§ä½¿ç”¨ã™ã‚‹åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>

    <input id="username" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" class="thread-input"><br><br>

    <div style="position:relative; width:95%;">
        <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="thread-input" style="width:100%;">
        <button type="button" onclick="togglePass()" 
            style="position:absolute; right:5px; top:5px;">ğŸ‘</button>
    </div>

    <br>
    <button class="thread-create-btn" onclick="registerUser()">ç™»éŒ²</button>

    <p>ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ â†’ <a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a></p>

    <div id="log" style="margin-top:20px; color:#AA0000;"></div>
</div>

<script>
// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
function togglePass() {
    const p = document.getElementById("password");
    p.type = (p.type === "password") ? "text" : "password";
}

// â–¼ æ–°è¦ç™»éŒ²å‡¦ç†
async function registerUser() {

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    const logBox = document.getElementById("log");
    logBox.innerHTML = "";

    if (!username || !password) {
        logBox.innerHTML = "âš  ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
    }

    // â–¼ é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆmaybeSingle ã¯ä½¿ã‚ãªã„ï¼‰
    const { data: existList } = await sb
        .from("users")
        .select("id")
        .eq("username", username);

    if (existList && existList.length > 0) {
        logBox.innerHTML = "âš  ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ã™ã§ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™";
        return;
    }

    // â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ SHA-256 ã§ãƒãƒƒã‚·ãƒ¥åŒ–
    const hashBuffer = await crypto.subtle.digest(
        "SHA-256",
        new TextEncoder().encode(password)
    );
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");

    // â–¼ ç™»éŒ²
    const { error: insertErr } = await sb
        .from("users")
        .insert({
            username,
            password_hash: hashHex
        });

    if (insertErr) {
        logBox.innerHTML = "âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼ï¼š" + insertErr.message;
        return;
    }

    // æˆåŠŸ â†’ login.html ã¸
    window.location.href = "login.html";
}
</script>

</body>
</html>
