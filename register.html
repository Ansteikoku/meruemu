<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新規登録</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<script>
// ▼ ログイン済みなら index へ
if (localStorage.getItem("username")) {
    window.location.href = "index.html";
}
</script>

<div class="container">
    <h1>新規登録</h1>

    <p>ユーザー名とパスワードを登録してください。</p>

    <input id="username" type="text" placeholder="ユーザー名"><br><br>

    <div>
        <input id="password" type="password" placeholder="パスワード">
        <button onclick="togglePw()">表示</button>
    </div>
    <br>

    <button onclick="registerUser()">登録</button>

    <p><a href="login.html">ログインはこちら</a></p>
</div>

<script>
// ▼ パスワード表示/非表示
function togglePw() {
    const pw = document.getElementById("password");
    pw.type = pw.type === "password" ? "text" : "password";
}

// ▼ SHA-256 ハッシュ
async function sha256(text) {
    const enc = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
}

// ▼ ユーザー登録
async function registerUser() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    if (!username || !password) {
        alert("ユーザー名とパスワードを入力してください");
        return;
    }

    const passHash = await sha256(password);

    const { error } = await sb.from("users").insert({
        username,
        password_hash: passHash
    });

    if (error) {
        if (error.code === "23505") {
            alert("その名前は既に使われています");
        } else {
            alert("エラー：" + error.message);
        }
        return;
    }

    localStorage.setItem("username", username);
    window.location.href = "index.html";
}
</script>

</body>
</html>
