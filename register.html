<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新規登録</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>

    <style>
    #logBox {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #CC0000;
        background: #FFECEC;
        color: #CC0000;
        display: none;
    }
    </style>
</head>

<body>

<div class="container">
    <h1>新規登録</h1>

    <input id="username" type="text" placeholder="ユーザー名" class="post-input"><br><br>

    <div style="display:flex; align-items:center;">
        <input id="password" type="password" placeholder="パスワード" class="post-input" style="width:100%;">
        <button id="togglePw" style="margin-left:5px;">表示</button>
    </div><br>

    <button onclick="registerUser()" class="post-btn">登録</button><br><br>

    <a href="login.html">ログインはこちら</a>

    <!-- ▼ ログ表示 -->
    <div id="logBox"></div>
</div>

<script>
// ログ出力
function log(msg){
    const box = document.getElementById("logBox");
    box.style.display = "block";
    box.textContent = msg;
}

// パスワード表示切替
document.getElementById("togglePw").onclick = () => {
    const pw = document.getElementById("password");
    if (pw.type === "password") {
        pw.type = "text";
        togglePw.textContent = "非表示";
    } else {
        pw.type = "password";
        togglePw.textContent = "表示";
    }
};

// SHA-256 ハッシュ
async function hash(str) {
    const buf = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest("SHA-256", buf);
    return [...new Uint8Array(digest)]
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

async function registerUser() {

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    if (!username || !password) {
        log("ユーザー名とパスワードを入力してください。");
        return;
    }

    // 重複チェック
    const { data: exist } = await sb
        .from("users")
        .select("id")
        .eq("username", username)
        .maybeSingle();

    if (exist) {
        log("⚠ このユーザー名はすでに使用されています。別の名前を使用してください。");
        return;
    }

    // パスワードハッシュ作成
    const pwdHash = await hash(password);

    // 新規登録
    const { error } = await sb.from("users").insert({
        username,
        password_hash: pwdHash
    });

    if (error) {
        log("登録エラー：" + error.message);
        return;
    }

    // 自動ログイン
    localStorage.setItem("username", username);
    window.location.href = "index.html";
}

</script>

</body>
</html>
