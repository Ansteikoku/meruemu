<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>名前登録ページ</title>
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>

<body>

<div class="register-wrapper">

    <h1>名前を登録してください</h1>

    <h3>■ 新規登録</h3>
    <input id="regName" type="text" placeholder="名前"><br><br>
    <input id="regPass" type="password" placeholder="パスワード"><br><br>
    <button onclick="registerUser()">登録</button>

    <hr>

    <h3>■ ログイン</h3>
    <input id="loginName" type="text" placeholder="名前"><br><br>
    <input id="loginPass" type="password" placeholder="パスワード"><br><br>
    <button onclick="loginUser()">ログイン</button>

</div>

<script>
// ---- SHA256 ----
async function sha256(text) {
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = [...new Uint8Array(hashBuffer)];
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

// ---- 新規登録 ----
async function registerUser(){
    const name = document.getElementById("regName").value.trim();
    const pass = document.getElementById("regPass").value.trim();

    if(!name || !pass){
        alert("名前とパスワードを入力してください");
        return;
    }

    const password_hash = await sha256(pass);

    // 既存ユーザー確認
    const { data: exists } = await sb
        .from("users")
        .select("id")
        .eq("username", name)
        .maybeSingle();

    if(exists){
        alert("この名前は既に使われています");
        return;
    }

    // 登録
    await sb.from("users").insert({
        username: name,
        password_hash
    });

    alert("登録完了！ログインしてください。");
}

// ---- ログイン ----
async function loginUser(){
    const name = document.getElementById("loginName").value.trim();
    const pass = document.getElementById("loginPass").value.trim();

    if(!name || !pass){
        alert("名前とパスワードを入力してください");
        return;
    }

    const password_hash = await sha256(pass);

    const { data } = await sb
        .from("users")
        .select("*")
        .eq("username", name)
        .eq("password_hash", password_hash)
        .maybeSingle();

    if(!data){
        alert("名前またはパスワードが違います");
        return;
    }

    // ログイン成功 → ローカル保存
    localStorage.setItem("username", name);
    localStorage.setItem("user_id", data.id);

    // index へ移動
    window.location.href = "index.html";
}

</script>

</body>
</html>
