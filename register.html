<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新規登録</title>
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<div class="container">

    <h1>新規登録</h1>

    <p>掲示板で使うユーザー名とパスワードを登録してください。</p>

    <input id="username" type="text" placeholder="ユーザー名（全角OK）" class="post-input"><br><br>

    <div style="display:flex; gap:8px; align-items:center;">
        <input id="password" type="password" placeholder="パスワード" class="post-input" style="flex:1;">
        <button onclick="togglePass('password')" class="post-btn">表示</button>
    </div>
    <br>

    <button onclick="registerUser()" class="post-btn">登録</button>

    <p>すでに登録済み？ → <a href="login.html">ログインへ</a></p>

</div>

<script>
// ----------------------------------------
// SHA-256 ハッシュ関数
// ----------------------------------------
async function sha256(text) {
    const msgUint8 = new TextEncoder().encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join('');
}

// ----------------------------------------
// パスワード表示切り替え
// ----------------------------------------
function togglePass(id) {
    const input = document.getElementById(id);
    input.type = (input.type === "password") ? "text" : "password";
}

// ----------------------------------------
// 新規登録
// ----------------------------------------
async function registerUser() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!username || !password) {
        alert("すべて入力してください");
        return;
    }

    // パスワードをハッシュ化
    const passwordHash = await sha256(password);

    // ユーザー名の重複チェック
    const { data: existsUser } = await sb
        .from("users")
        .select("id")
        .eq("username", username)
        .maybeSingle();

    if (existsUser) {
        alert("このユーザー名はすでに使われています");
        return;
    }

    // Supabase へ保存
    const { error } = await sb.from("users").insert({
        username,
        password_hash: passwordHash
    });

    if (error) {
        alert("登録エラー：" + error.message);
        return;
    }

    // ログイン状態にする
    localStorage.setItem("username", username);

    window.location.href = "index.html";
}
</script>

</body>
</html>
