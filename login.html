<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ­ã‚°ã‚¤ãƒ³</title>
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<div class="container">
    <h1>ãƒ­ã‚°ã‚¤ãƒ³</h1>

    <input id="username" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" class="thread-input"><br><br>

    <div style="position:relative; width:95%;">
        <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="thread-input" style="width:100%;">
        <button type="button" onclick="togglePass()" 
            style="position:absolute; right:5px; top:5px;">ğŸ‘</button>
    </div>

    <br>
    <button class="thread-create-btn" onclick="loginUser()">ãƒ­ã‚°ã‚¤ãƒ³</button>

    <p>ã¾ã ç™»éŒ²ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ â†’ <a href="register.html">æ–°è¦ç™»éŒ²</a></p>

    <div id="log" style="margin-top:20px; color:#AA0000;"></div>
</div>

<script>
// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡æ›¿
function togglePass() {
    const p = document.getElementById("password");
    p.type = (p.type === "password") ? "text" : "password";
}

// â–¼ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
async function loginUser() {

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;
    const logBox = document.getElementById("log");
    logBox.innerHTML = "";

    if (!username || !password) {
        logBox.innerHTML = "âš  ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
    }

    // â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’åŒã˜æ–¹æ³•ã§ãƒãƒƒã‚·ãƒ¥
    const hashBuffer = await crypto.subtle.digest(
        "SHA-256",
        new TextEncoder().encode(password)
    );
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");

    // â–¼ Supabase ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
    const { data: userList } = await sb
        .from("users")
        .select("*")
        .eq("username", username)
        .eq("password_hash", hashHex);

    if (!userList || userList.length === 0) {
        logBox.innerHTML = "âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
        return;
    }

    // â–¼ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
    localStorage.setItem("username", username);
    window.location.href = "index.html";
}
</script>

</body>
</html>
