<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ­ã‚°ã‚¤ãƒ³</title>
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>

<script>
// â–¼ ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã¯ index ã¸
if (localStorage.getItem("username")) {
    window.location.href = "index.html";
}
</script>

<div class="container">

    <h1>ãƒ­ã‚°ã‚¤ãƒ³</h1>

    <p style="color:red;" id="error"></p>

    <input id="username" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"><br><br>

    <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="togglePw()">ğŸ‘</button>
    <br><br>

    <button onclick="loginUser()">ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<script>

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
function togglePw() {
    const pw = document.getElementById("password");
    pw.type = pw.type === "password" ? "text" : "password";
}

// â–¼ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
async function loginUser() {

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    if (!username || !password) {
        document.getElementById("error").textContent = "å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
    }

    // ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆSHA-256ï¼‰
    const enc = new TextEncoder();
    const hashBuffer = await crypto.subtle.digest("SHA-256", enc.encode(password));
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const password_hash = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
    const { data: user, error } = await sb
        .from("users")
        .select("*")
        .eq("username", username)
        .eq("password_hash", password_hash)
        .single();

    if (error || !user) {
        document.getElementById("error").textContent = "åå‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
        return;
    }

    // ä¿å­˜
    localStorage.setItem("username", username);

    // index ã¸ç§»å‹•
    window.location.href = "index.html";
}
</script>

</body>
</html>
